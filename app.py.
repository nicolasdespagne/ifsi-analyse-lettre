!pip install openai gradio

import openai
import gradio as gr
import os

# ğŸ”‘ ClÃ© API OpenAI (Remplace par ta clÃ©)
from dotenv import load_dotenv
load_dotenv()

def is_valid_motivation_letter(text):
    """ VÃ©rifie si le texte correspond bien Ã  une lettre de motivation pour l'IFSI. """
    keywords = ["infirmier", "IFSI", "motivation", "soins", "patients", "stages", "formation", "Ã©tudes"]
    return any(word in text.lower() for word in keywords) and len(text) > 200

def analyze_ifsi_motivation(motivation):
    try:
        if not os.environ["OPENAI_API_KEY"]:
            return "âŒ Erreur : La clÃ© API OpenAI est absente. VÃ©rifiez votre configuration."

        if not is_valid_motivation_letter(motivation):
            return "âŒ Le texte soumis ne semble pas Ãªtre une lettre de motivation pour l'IFSI. Merci de vÃ©rifier votre saisie."

        client = openai.OpenAI()
        thread = client.beta.threads.create()

        user_message = f"""
        ## ğŸ“„ Analyse de la Lettre de Motivation IFSI

        ğŸ“Œ **Lettre de Motivation** :
        {motivation}

        ---
        ğŸ” **Consignes pour lâ€™analyse** :
        - VÃ©rifier si le texte est bien une lettre de motivation pour lâ€™IFSI.
        - Analyser **les points forts et les axes dâ€™amÃ©lioration**.
        - Donner des recommandations pour optimiser la lettre.
        """

        client.beta.threads.messages.create(
            thread_id=thread.id,
            role="user",
            content=user_message
        )

        run = client.beta.threads.runs.create(
            thread_id=thread.id,
            assistant_id=ASSISTANT_ID
        )

        while True:
            run_status = client.beta.threads.runs.retrieve(thread_id=thread.id, run_id=run.id)
            if run_status.status == "completed":
                break

        messages = client.beta.threads.messages.list(thread_id=thread.id)

        # âœ… VÃ©rification si l'API retourne bien du contenu
        if not messages.data or not messages.data[0].content:
            return "âŒ Erreur : L'analyse de la lettre n'a pas fonctionnÃ©. Merci de rÃ©essayer plus tard."

        response = messages.data[0].content[0].text.value

        # âœ… VÃ©rification si la structure du texte retournÃ© est correcte avant de faire des split()
        if "ğŸ† âœ… Points forts :" not in response or "ğŸš€ ğŸ› ï¸ Points Ã  amÃ©liorer :" not in response:
            return f"âš ï¸ Lâ€™analyse a dÃ©tectÃ© des Ã©lÃ©ments intÃ©ressants, mais un ajustement personnalisÃ© pourrait amÃ©liorer la candidature. DÃ©couvrez les rÃ©sultats :\n\n{response}"

        formatted_response = f"""
        ## ğŸ¯ Analyse personnalisÃ©e de ta lettre de motivation :

        ğŸ† âœ… **Points forts :**  
        {response.split("ğŸ† âœ… Points forts :")[1].split("ğŸš€ ğŸ› ï¸ Points Ã  amÃ©liorer :")[0].strip()}

        ğŸš€ ğŸ› ï¸ **Axes d'amÃ©lioration :**  
        {response.split("ğŸš€ ğŸ› ï¸ Points Ã  amÃ©liorer :")[1].strip()}

        ---
        ğŸ“¢ **Besoin dâ€™un avis expert pour aller plus loin ?**  
        ğŸ¯ Un **coaching personnalisÃ©** peut tâ€™aider Ã  structurer ta lettre, affiner tes arguments et optimiser tes chances dâ€™admission en IFSI ! ğŸš€  
        """
        
        return formatted_response

    except Exception as e:
        return f"âŒ Erreur : {str(e)}"

# ğŸŒŸ Interface utilisateur avec Gradio
with gr.Blocks() as app:
    gr.Markdown("# ğŸ“ **Ã‰valuation de votre Lettre de Motivation IFSI**")
    gr.Markdown("DÃ©posez votre lettre et recevez une analyse dÃ©taillÃ©e avec des conseils personnalisÃ©s.")

    input_text = gr.Textbox(label="Lettre de Motivation", lines=15, placeholder="Copie ta lettre ici...")
    output_text = gr.Markdown()

    btn = gr.Button("ğŸ“© Soumettre")

    btn.click(fn=analyze_ifsi_motivation, inputs=input_text, outputs=output_text)

# ğŸš€ Lancer lâ€™application Gradio
app.launch()
